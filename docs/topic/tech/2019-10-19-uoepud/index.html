<!DOCTYPE html>
<html lang="zh-cmn-Hans">
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"> 
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css">
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"> 
    <link rel="stylesheet" href="../../../fonts/academicons-1.8.6/css/academicons.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
    <link rel="icon" type="image/png" sizes="32x32" href="../../../img/logo.png"> 
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    
    
    
    
    
    <title>R 语言中的高级图像处理包 - Steven Shen | 沈维燕</title> 
    <meta property="og:title" content="R 语言中的高级图像处理包 - Steven Shen | 沈维燕">
    

    
      
    

    

    
  
    <link rel="stylesheet" href="https://shen.bioitee.com/css/style.css"/>
    <link rel="stylesheet" href="https://shen.bioitee.com/css/fonts.css"/>
    

<link rel="stylesheet" href="https://shen.bioitee.com/css/custom.css" />

  </head>

  
  <body class="topic">
    
    
    <header class="intro-and-nav" role="banner">
    <div>
      <div class="intro">
        <a class="logo" href="../../../" aria-label="Steven Shen | 沈维燕 home page">
          <img src="https://shen.bioitee.com/img/logo.png" alt="">
        </a>
        <p class="library-desc">
          
            Welcome to the blog site of Steven Shen.
          
        </p>
      </div>
      <nav id="patterns-nav" class="patterns" role="navigation">
        <h2 class="vh">Main navigation</h2>
        <button id="menu-button" aria-expanded="false">
          
          Menu
        </button>
        
        <ul id="patterns-list">
          
          <li class="pattern">
          
          
          
            <a href="../../../" >
              
              首页
            </a>
          </li>
          
          <li class="pattern">
          
          
          
            <a href="../../../topic/tech/" >
              
              技术
            </a>
          </li>
          
          <li class="pattern">
          
          
          
            <a href="../../../topic/life/" >
              
              生活
            </a>
          </li>
          
          <li class="pattern">
          
          
          
            <a href="../../../topic/read/" >
              
              读书
            </a>
          </li>
          
          <li class="pattern">
          
          
          
            <a href="../../../topic/tags/" >
              
              标签
            </a>
          </li>
          
          <li class="pattern">
          
          
          
            <a href="../../../topic/archives/" >
              
              归档
            </a>
          </li>
          
          

<li class="pattern">&nbsp;&nbsp;</li>



<li class="pattern"><a href="https://github.com/shenweiyan/shen.bioitee.com/edit/master/content/topic/tech/2019-10-19-uoepud.md" target="_blank">编辑</a></li>


<li class="pattern"><a href="../../../topic/index.xml" type="application/rss+xml" title="RSS feed">订阅</a></li>

<li class="pattern"><a href="../../../declare/" title="声明">声明</a></li>


        </ul>
      </nav>
    </div>
    </header>

    <article class="main">
      <header class="title">
      
  



<h1>R 语言中的高级图像处理包</h1>






<h3>
2019-10-19</h3> 


   
  



      </header>


  
  
  

  
  
  

  

<p>最新的 <a href="https://cran.r-project.org/package=magick">magick</a> 包是为能够在 R 中更现代化、简单化高质量图像处理而进行的一次努力。该包封装了目前最强大的开源图片处理库 <a href="https://www.imagemagick.org/Magick++/STL.html">ImageMagick STL</a> 。</p>

<p>ImageMagick 库具有大量功能。当前版本的 Magick 公开了很多内容，但是作为第一个发行版本，文档仍然很少。本文简单的介绍了其中一些最重要的概念来帮助了解 <code>magick</code> 。</p>

<h2 id="安装-magick">安装 magick</h2>

<p>在 Windows 或者 MacOS，可以通过 CRAN 安装该软件包。</p>

<pre><code class="language-r">install.packages(&quot;magick&quot;)
</code></pre>

<p>二进制 CRAN 软件包开箱即用，只需少量的工作，就可以使绝大多数的重要特性得以实现。使用 <code>magick_config</code> 可以查看您的 ImageMagick 版本支持哪些功能和格式。</p>

<pre><code class="language-r">&gt; library(magick)
Linking to ImageMagick 6.9.9.14
Enabled features: cairo, freetype, fftw, ghostscript, lcms, pango, rsvg, webp
Disabled features: fontconfig, x11
</code></pre>

<pre><code class="language-r">&gt; str(magick::magick_config())
List of 21
 $ version           :Class 'numeric_version'  hidden list of 1
  ..$ : int [1:4] 6 9 9 14
 $ modules           : logi FALSE
 $ cairo             : logi TRUE
 $ fontconfig        : logi FALSE
 $ freetype          : logi TRUE
 $ fftw              : logi TRUE
 $ ghostscript       : logi TRUE
 $ jpeg              : logi TRUE
 $ lcms              : logi TRUE
 $ libopenjp2        : logi FALSE
 $ lzma              : logi TRUE
 $ pangocairo        : logi TRUE
 $ pango             : logi TRUE
 $ png               : logi TRUE
 $ rsvg              : logi TRUE
 $ tiff              : logi TRUE
 $ webp              : logi TRUE
 $ wmf               : logi FALSE
 $ x11               : logi FALSE
 $ xml               : logi TRUE
 $ zero-configuration: logi TRUE
</code></pre>

<h2 id="源码编译">源码编译</h2>

<p>Linux 下你需要安装 ImageMagick++ 库。在 Debian/Ubuntu，这个库叫 <a href="https://packages.debian.org/testing/libmagick++-dev">libmagick++-dev</a>：</p>

<pre><code class="language-bash">sudo apt-get install libmagick++-dev
</code></pre>

<p>在 Fedora 或者 CentOS/RHEL 我们需要安装 <a href="https://apps.fedoraproject.org/packages/ImageMagick-c++-devel">ImageMagick-c++-devel</a>：</p>

<pre><code class="language-bash">sudo yum install ImageMagick-c++-devel
</code></pre>

<p>要从 macOS 上的源代码安装，您需要来自 homebrew 的 <code>imagemagick@6</code> 。</p>

<pre><code class="language-bash">brew install imagemagick@6
</code></pre>

<p>不幸的是，当前 homebrew 上的 <code>imagemagick@6</code> 配置禁用了许多功能，包括 librsvg 和 fontconfig。 因此，字体和 svg 渲染的质量可能不是最佳的（建议安装时至少加上 <code>--with-fontconfig</code> 和 <code>--with-librsvg</code> 选项来支持高质量的字体和 svg 渲染。CRAN 上的 OS-Xe 二进制包已经默认配置好了）。</p>

<h2 id="图像输入输出">图像输入输出</h2>

<p>magick 之所以如此神奇，是因为它会自动转换并呈现所有常见的图像格式。ImageMagick 支持数十种格式并自动检测类型。使用 <code>magick::magick_config()</code> 可以列出您的 ImageMagick 版本支持的格式。</p>

<h3 id="读和写">读和写</h3>

<p>可以使用 <code>image_read</code> 从图像数据的文件路径，URL 或原始矢量直接读取图像。<code>image_info</code> 函数显示有关图像的一些元数据，类似 于 imagemagick 标识命令行实用程序。</p>

<pre><code class="language-r">library(magick)
tiger &lt;- image_read_svg('http://jeroen.github.io/images/tiger.svg', width = 350)
print(tiger)
</code></pre>

<pre><code class="language-r">##   format width height colorspace matte filesize density
## 1    PNG   350    350       sRGB  TRUE        0   72x72
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571363977241-d10806a5-682d-4b4c-8dc7-339751c0eb61.png#align=left&amp;display=inline&amp;height=175&amp;name=image.png&amp;originHeight=350&amp;originWidth=350&amp;size=98851&amp;status=done&amp;width=175"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571363977241-d10806a5-682d-4b4c-8dc7-339751c0eb61.png#align=left&amp;display=inline&amp;height=175&amp;name=image.png&amp;originHeight=350&amp;originWidth=350&amp;size=98851&amp;status=done&amp;width=175" alt=""></a></p>

<p>我们使用 <code>image_write</code> 将任何格式的图像导出为磁盘上的文件，或者如果 <code>path = NULL</code> 则导出到内存中的文件。</p>

<pre><code class="language-r"># Render svg to png bitmap
image_write(tiger, path = &quot;tiger.png&quot;, format = &quot;png&quot;)
</code></pre>

<p>如果 <code>path</code> 是文件名，则 <code>image_write</code> 成功返回 <code>path</code>，以便可以将结果通过文件路径传递给函数。</p>

<h3 id="转换格式">转换格式</h3>

<p>Magick 以原始格式将图像保留在内存中。你可以在 <code>image_write</code> 中通过指定格式参数以转换为另一种格式。或者还可以在应用转换之前，先在内部将图像转换为其他格式。如果你的原始格式是有损的，这将很有用。</p>

<pre><code class="language-r">tiger_png &lt;- image_convert(tiger, &quot;png&quot;)
image_info(tiger_png)
</code></pre>

<pre><code class="language-r">##   format width height colorspace matte filesize density
## 1    PNG   350    350       sRGB  TRUE        0   72x72
</code></pre>

<h3 id="预览">预览</h3>

<p>具有内置网络浏览器（例如 RStudio）的 IDE 会在查看器中自动显示魔术图像。这就形成了一个整洁的交互式图像编辑环境。</p>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571371499649-43035f4a-a386-4678-a30a-2aeb1e981489.png#align=left&amp;display=inline&amp;height=768&amp;name=aaa1.png&amp;originHeight=768&amp;originWidth=1365&amp;size=190879&amp;status=done&amp;width=1365"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571371499649-43035f4a-a386-4678-a30a-2aeb1e981489.png#align=left&amp;display=inline&amp;height=768&amp;name=aaa1.png&amp;originHeight=768&amp;originWidth=1365&amp;size=190879&amp;status=done&amp;width=1365" alt="aaa1.png"></a></p>

<p>另外，在 Linux 上，您可以使用 <code>image_display</code> 在 X11 窗口中预览图像。最后，<code>image_browse</code> 会在你系统默认的应用程序中为给定类型打开图像。</p>

<pre><code class="language-r"># X11 only
image_display(tiger)

# System dependent
image_browse(tiger)
</code></pre>

<p>另一种方法是将图像转换为栅格对象，然后将其绘制在 R 的图形显示上。但是，这非常慢，并且仅在与其他绘图功能结合使用时才有用。 请参阅下面的 #raster。</p>

<h2 id="转变">转变</h2>

<p>了解可用转换的最佳方法是遍历 RStudio中 <code>?transformations</code> 页面中的示例。下面是一些示例。</p>

<h3 id="剪切与编辑">剪切与编辑</h3>

<p>一些转换函数采用了 <code>geometry</code> 参数，该参数需要 <code>AxB + C + D</code> 形式的特殊语法，其中每个元素都是可选的。 一些例子：</p>

<ul>
<li><code>image_crop(image, &quot;100x150+50&quot;)</code>: crop out <code>width:100px</code> and <code>height:150px</code> starting <code>+50px</code> from the left</li>
<li><code>image_scale(image, &quot;200&quot;)</code>: resize proportionally to width: <code>200px</code></li>
<li><code>image_scale(image, &quot;x200&quot;)</code>: resize proportionally to height: <code>200px</code></li>
<li><code>image_fill(image, &quot;blue&quot;, &quot;+100+200&quot;)</code>: flood fill with blue starting at the point at <code>x:100, y:200</code></li>
<li><code>image_border(frink, &quot;red&quot;, &quot;20x10&quot;)</code>: adds a border of 20px left+right and 10px top+bottom</li>
</ul>

<p>完整的语法，可以参考 <a href="http://www.imagemagick.org/Magick++/Geometry.html">Magick::Geometry</a> 文档。</p>

<pre><code class="language-r"># Example image
frink &lt;- image_read(&quot;https://jeroen.github.io/images/frink.png&quot;)
print(frink)
</code></pre>

<pre><code class="language-r">##   format width height colorspace matte filesize density
## 1    PNG   220    445       sRGB  TRUE    73494   72x72
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571366136037-a75b9f9d-1b82-42e4-a611-b11140823c5c.png#align=left&amp;display=inline&amp;height=445&amp;name=image.png&amp;originHeight=445&amp;originWidth=220&amp;size=67143&amp;status=done&amp;width=220"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571366136037-a75b9f9d-1b82-42e4-a611-b11140823c5c.png#align=left&amp;display=inline&amp;height=445&amp;name=image.png&amp;originHeight=445&amp;originWidth=220&amp;size=67143&amp;status=done&amp;width=220" alt=""></a></p>

<pre><code class="language-r"># Add 20px left/right and 10px top/bottom
image_border(image_background(frink, &quot;hotpink&quot;), &quot;#000080&quot;, &quot;20x10&quot;)
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571366166735-29222db4-bb0f-4f74-9383-7a4189b3305b.png#align=left&amp;display=inline&amp;height=465&amp;name=image.png&amp;originHeight=465&amp;originWidth=260&amp;size=65910&amp;status=done&amp;width=260"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571366166735-29222db4-bb0f-4f74-9383-7a4189b3305b.png#align=left&amp;display=inline&amp;height=465&amp;name=image.png&amp;originHeight=465&amp;originWidth=260&amp;size=65910&amp;status=done&amp;width=260" alt=""></a></p>

<pre><code class="language-r"># Trim margins
image_trim(frink)
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571366274140-f41c6a57-c19e-4e94-8b1b-a5c1533c5747.png#align=left&amp;display=inline&amp;height=431&amp;name=image.png&amp;originHeight=431&amp;originWidth=139&amp;size=65654&amp;status=done&amp;width=139"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571366274140-f41c6a57-c19e-4e94-8b1b-a5c1533c5747.png#align=left&amp;display=inline&amp;height=431&amp;name=image.png&amp;originHeight=431&amp;originWidth=139&amp;size=65654&amp;status=done&amp;width=139" alt=""></a></p>

<pre><code class="language-r"># Passport pica
image_crop(frink, &quot;100x150+50&quot;)
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571366305125-ab6d58c9-4c98-4f73-ad18-220463afb3d8.png#align=left&amp;display=inline&amp;height=150&amp;name=image.png&amp;originHeight=150&amp;originWidth=100&amp;size=18879&amp;status=done&amp;width=100"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571366305125-ab6d58c9-4c98-4f73-ad18-220463afb3d8.png#align=left&amp;display=inline&amp;height=150&amp;name=image.png&amp;originHeight=150&amp;originWidth=100&amp;size=18879&amp;status=done&amp;width=100" alt=""></a></p>

<pre><code class="language-r"># Resize
image_scale(frink, &quot;300&quot;) # width: 300px
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571366322735-b025bbb2-701f-4e3a-b055-d9855c5fb51f.png#align=left&amp;display=inline&amp;height=607&amp;name=image.png&amp;originHeight=607&amp;originWidth=300&amp;size=111615&amp;status=done&amp;width=300"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571366322735-b025bbb2-701f-4e3a-b055-d9855c5fb51f.png#align=left&amp;display=inline&amp;height=607&amp;name=image.png&amp;originHeight=607&amp;originWidth=300&amp;size=111615&amp;status=done&amp;width=300" alt=""></a></p>

<pre><code class="language-r">image_scale(frink, &quot;x300&quot;) # height: 300px
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571366340578-e5a52536-8f19-4f6b-a70e-1100b196c4bf.png#align=left&amp;display=inline&amp;height=300&amp;name=image.png&amp;originHeight=300&amp;originWidth=148&amp;size=36231&amp;status=done&amp;width=148"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571366340578-e5a52536-8f19-4f6b-a70e-1100b196c4bf.png#align=left&amp;display=inline&amp;height=300&amp;name=image.png&amp;originHeight=300&amp;originWidth=148&amp;size=36231&amp;status=done&amp;width=148" alt=""></a></p>

<pre><code class="language-r"># Rotate or mirror
image_rotate(frink, 45)
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571366359054-2949de29-a259-487b-b08c-5a5f92838a7a.png#align=left&amp;display=inline&amp;height=473&amp;name=image.png&amp;originHeight=473&amp;originWidth=472&amp;size=86173&amp;status=done&amp;width=472"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571366359054-2949de29-a259-487b-b08c-5a5f92838a7a.png#align=left&amp;display=inline&amp;height=473&amp;name=image.png&amp;originHeight=473&amp;originWidth=472&amp;size=86173&amp;status=done&amp;width=472" alt=""></a></p>

<pre><code class="language-r">image_flip(frink)
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571366386677-24b88b4e-c005-41d7-97bb-b9268e5ce736.png#align=left&amp;display=inline&amp;height=445&amp;name=image.png&amp;originHeight=445&amp;originWidth=220&amp;size=67639&amp;status=done&amp;width=220"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571366386677-24b88b4e-c005-41d7-97bb-b9268e5ce736.png#align=left&amp;display=inline&amp;height=445&amp;name=image.png&amp;originHeight=445&amp;originWidth=220&amp;size=67639&amp;status=done&amp;width=220" alt=""></a></p>

<pre><code class="language-r">image_flop(frink)
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571366403173-99d32e94-67b6-41e7-8cd9-3edb70aeeff6.png#align=left&amp;display=inline&amp;height=445&amp;name=image.png&amp;originHeight=445&amp;originWidth=220&amp;size=67288&amp;status=done&amp;width=220"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571366403173-99d32e94-67b6-41e7-8cd9-3edb70aeeff6.png#align=left&amp;display=inline&amp;height=445&amp;name=image.png&amp;originHeight=445&amp;originWidth=220&amp;size=67288&amp;status=done&amp;width=220" alt=""></a></p>

<pre><code class="language-r"># Brightness, Saturation, Hue
image_modulate(frink, brightness = 80, saturation = 120, hue = 90)
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571366420331-91f363ae-bc18-4976-85d5-a8439bf40efa.png#align=left&amp;display=inline&amp;height=445&amp;name=image.png&amp;originHeight=445&amp;originWidth=220&amp;size=70269&amp;status=done&amp;width=220"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571366420331-91f363ae-bc18-4976-85d5-a8439bf40efa.png#align=left&amp;display=inline&amp;height=445&amp;name=image.png&amp;originHeight=445&amp;originWidth=220&amp;size=70269&amp;status=done&amp;width=220" alt=""></a></p>

<pre><code class="language-r"># Paint the shirt orange
image_fill(frink, &quot;orange&quot;, point = &quot;+100+200&quot;, fuzz = 20)
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571366435980-80cc29c2-57b5-4cee-a169-7fc47219ae99.png#align=left&amp;display=inline&amp;height=445&amp;name=image.png&amp;originHeight=445&amp;originWidth=220&amp;size=66473&amp;status=done&amp;width=220"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571366435980-80cc29c2-57b5-4cee-a169-7fc47219ae99.png#align=left&amp;display=inline&amp;height=445&amp;name=image.png&amp;originHeight=445&amp;originWidth=220&amp;size=66473&amp;status=done&amp;width=220" alt=""></a></p>

<p>使用 <code>image_fill</code>，我们可以从像素点开始填充。模糊参数允许填充物穿过具有相似颜色的相邻像素。值必须在 0 到 256^2 之间，指定要视为相等的颜色之间的最大几何距离。在这里，我们给教授 Frink 一件橙色的世界杯衬衫。</p>

<h3 id="滤镜和效果">滤镜和效果</h3>

<p>ImageMagick 还具有许多值得去检查尝试的标准效果。</p>

<pre><code class="language-r"># Add randomness
image_blur(frink, 10, 5)
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571366664424-71f9ade6-c84d-4e7d-a19a-b30c497b55ad.png#align=left&amp;display=inline&amp;height=445&amp;name=image.png&amp;originHeight=445&amp;originWidth=220&amp;size=73778&amp;status=done&amp;width=220"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571366664424-71f9ade6-c84d-4e7d-a19a-b30c497b55ad.png#align=left&amp;display=inline&amp;height=445&amp;name=image.png&amp;originHeight=445&amp;originWidth=220&amp;size=73778&amp;status=done&amp;width=220" alt=""></a></p>

<pre><code class="language-r">image_noise(frink)
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571366681562-0a0f20d7-f999-42aa-9930-c876c931ea9f.png#align=left&amp;display=inline&amp;height=445&amp;name=image.png&amp;originHeight=445&amp;originWidth=220&amp;size=257790&amp;status=done&amp;width=220"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571366681562-0a0f20d7-f999-42aa-9930-c876c931ea9f.png#align=left&amp;display=inline&amp;height=445&amp;name=image.png&amp;originHeight=445&amp;originWidth=220&amp;size=257790&amp;status=done&amp;width=220" alt=""></a></p>

<pre><code class="language-r"># Silly filters
image_charcoal(frink)
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571366703127-26ab3f9b-6d53-4451-aba5-08e2128e6b13.png#align=left&amp;display=inline&amp;height=445&amp;name=image.png&amp;originHeight=445&amp;originWidth=220&amp;size=45240&amp;status=done&amp;width=220"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571366703127-26ab3f9b-6d53-4451-aba5-08e2128e6b13.png#align=left&amp;display=inline&amp;height=445&amp;name=image.png&amp;originHeight=445&amp;originWidth=220&amp;size=45240&amp;status=done&amp;width=220" alt=""></a></p>

<pre><code class="language-r">image_oilpaint(frink)
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571366723362-f5255ea1-adfc-4d4d-b4a0-5d9ea019e568.png#align=left&amp;display=inline&amp;height=445&amp;name=image.png&amp;originHeight=445&amp;originWidth=220&amp;size=50703&amp;status=done&amp;width=220"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571366723362-f5255ea1-adfc-4d4d-b4a0-5d9ea019e568.png#align=left&amp;display=inline&amp;height=445&amp;name=image.png&amp;originHeight=445&amp;originWidth=220&amp;size=50703&amp;status=done&amp;width=220" alt=""></a></p>

<pre><code class="language-r">image_negate(frink)
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571366740872-8511118e-ec6d-4a9b-88a1-bc4b7ef1eb5e.png#align=left&amp;display=inline&amp;height=445&amp;name=image.png&amp;originHeight=445&amp;originWidth=220&amp;size=67072&amp;status=done&amp;width=220"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571366740872-8511118e-ec6d-4a9b-88a1-bc4b7ef1eb5e.png#align=left&amp;display=inline&amp;height=445&amp;name=image.png&amp;originHeight=445&amp;originWidth=220&amp;size=67072&amp;status=done&amp;width=220" alt=""></a></p>

<h3 id="核卷积">核卷积</h3>

<p><code>image_convolve()</code> 函数在图像上实行 <a href="https://en.wikipedia.org/wiki/Kernel_(image_processing)">kernel</a> 变换。核卷积是指在核矩阵中，图片每个像素的值根据相邻像素的加权和重新计算。例如，让我们看一下这个简单的核变换：</p>

<pre><code class="language-r">kern &lt;- matrix(0, ncol = 3, nrow = 3)
kern[1, 2] &lt;- 0.25
kern[2, c(1, 3)] &lt;- 0.25
kern[3, 2] &lt;- 0.25
kern
</code></pre>

<pre><code class="language-r">##      [,1] [,2] [,3]
## [1,] 0.00 0.25 0.00
## [2,] 0.25 0.00 0.25
## [3,] 0.00 0.25 0.00
</code></pre>

<p>该核变换将每个像素更改为其水平和垂直相邻像素的平均值，从而在下面的右侧图像中产生轻微的模糊效果：</p>

<pre><code class="language-r">img &lt;- image_resize(logo, &quot;300x300&quot;)
img_blurred &lt;- image_convolve(img, kern)
image_append(c(img, img_blurred))
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/gif/126032/1571366903114-5f1667dc-6c23-4df0-a225-1f8ecb8e1101.gif#align=left&amp;display=inline&amp;height=225&amp;name=image.gif&amp;originHeight=225&amp;originWidth=600&amp;size=25690&amp;status=done&amp;width=600"><img src="https://note.bioitee.com/yuque/0/2019/gif/126032/1571366903114-5f1667dc-6c23-4df0-a225-1f8ecb8e1101.gif#align=left&amp;display=inline&amp;height=225&amp;name=image.gif&amp;originHeight=225&amp;originWidth=600&amp;size=25690&amp;status=done&amp;width=600" alt=""></a></p>

<p>或使用任何的 <a href="http://www.imagemagick.org/Usage/convolve/">standard kernels</a>：</p>

<pre><code class="language-r">img %&gt;% image_convolve('Sobel') %&gt;% image_negate()
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/gif/126032/1571366965528-22a3d069-1181-43b1-abca-f52d0e71b629.gif#align=left&amp;display=inline&amp;height=225&amp;name=image.gif&amp;originHeight=225&amp;originWidth=300&amp;size=9978&amp;status=done&amp;width=300"><img src="https://note.bioitee.com/yuque/0/2019/gif/126032/1571366965528-22a3d069-1181-43b1-abca-f52d0e71b629.gif#align=left&amp;display=inline&amp;height=225&amp;name=image.gif&amp;originHeight=225&amp;originWidth=300&amp;size=9978&amp;status=done&amp;width=300" alt=""></a></p>

<pre><code class="language-r">img %&gt;% image_convolve('DoG:0,0,2') %&gt;% image_negate()
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/gif/126032/1571366982841-25a840f5-7fed-4b69-bc5e-bb9b5188a5d2.gif#align=left&amp;display=inline&amp;height=225&amp;name=image.gif&amp;originHeight=225&amp;originWidth=300&amp;size=13371&amp;status=done&amp;width=300"><img src="https://note.bioitee.com/yuque/0/2019/gif/126032/1571366982841-25a840f5-7fed-4b69-bc5e-bb9b5188a5d2.gif#align=left&amp;display=inline&amp;height=225&amp;name=image.gif&amp;originHeight=225&amp;originWidth=300&amp;size=13371&amp;status=done&amp;width=300" alt=""></a></p>

<h3 id="文本注释">文本注释</h3>

<p>最后，在图像的最上层打印输出一些文本往往是十分有用的：</p>

<pre><code class="language-r"># Add some text
image_annotate(frink, &quot;bioinit&quot;, size = 70, gravity = &quot;southwest&quot;, color = &quot;green&quot;)
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571369836398-a4b5f616-68a7-4f47-8aec-6b8410e74142.png#align=left&amp;display=inline&amp;height=445&amp;name=bioinit.png&amp;originHeight=445&amp;originWidth=220&amp;size=67044&amp;status=done&amp;width=220"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571369836398-a4b5f616-68a7-4f47-8aec-6b8410e74142.png#align=left&amp;display=inline&amp;height=445&amp;name=bioinit.png&amp;originHeight=445&amp;originWidth=220&amp;size=67044&amp;status=done&amp;width=220" alt="bioinit.png"></a></p>

<pre><code class="language-r"># Customize text
image_annotate(frink, &quot;Welcome to bioinit&quot;, size = 30, color = &quot;red&quot;, boxcolor = &quot;pink&quot;,
  degrees = 60, location = &quot;+50+100&quot;)
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571369703379-1526b9d3-125c-4954-b7b8-77dfdc6ecdbd.png#align=left&amp;display=inline&amp;height=445&amp;name=preview.png&amp;originHeight=445&amp;originWidth=220&amp;size=66236&amp;status=done&amp;width=220"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571369703379-1526b9d3-125c-4954-b7b8-77dfdc6ecdbd.png#align=left&amp;display=inline&amp;height=445&amp;name=preview.png&amp;originHeight=445&amp;originWidth=220&amp;size=66236&amp;status=done&amp;width=220" alt="preview.png"></a></p>

<pre><code class="language-r"># Fonts may require ImageMagick has fontconfig
image_annotate(frink, &quot;Hello world, bioinit!&quot;, font = 'Times', size = 30)
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571369962344-a7fc94a3-0df1-42c7-ac68-561cd62ebc8a.png#align=left&amp;display=inline&amp;height=445&amp;name=he.png&amp;originHeight=445&amp;originWidth=220&amp;size=68715&amp;status=done&amp;width=220"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571369962344-a7fc94a3-0df1-42c7-ac68-561cd62ebc8a.png#align=left&amp;display=inline&amp;height=445&amp;name=he.png&amp;originHeight=445&amp;originWidth=220&amp;size=68715&amp;status=done&amp;width=220" alt="he.png"></a></p>

<p>大多数平台上支持的字体，包括 <code>&quot;sans&quot;</code>， <code>&quot;mono&quot;</code>， <code>&quot;serif&quot;</code>， <code>&quot;Times&quot;</code>， <code>&quot;Helvetica&quot;</code>， <code>&quot;Trebuchet&quot;</code>， <code>&quot;Georgia&quot;</code>， <code>&quot;Palatino&quot;</code> ，以及 <code>&quot;Comic Sans&quot;</code> 。</p>

<h3 id="与管道结合">与管道结合</h3>

<p>每个图像转换功能都会返回一个原始图像的修改后的副本。它不会影响原始图像。</p>

<pre><code class="language-r">frink &lt;- image_read(&quot;https://jeroen.github.io/images/frink.png&quot;)
frink2 &lt;- image_scale(frink, &quot;100&quot;)
image_info(frink)
</code></pre>

<pre><code class="language-r">##   format width height colorspace matte filesize density
## 1    PNG   220    445       sRGB  TRUE    73494   72x72
</code></pre>

<pre><code class="language-r">image_info(frink2)
</code></pre>

<pre><code class="language-r">##   format width height colorspace matte filesize density
## 1    PNG   100    202       sRGB  TRUE        0   72x72
</code></pre>

<p>因此，要组合转换，你需要将它们链接起来：</p>

<pre><code class="language-r">test &lt;- image_rotate(frink, 90)
test &lt;- image_background(test, &quot;blue&quot;, flatten = TRUE)
test &lt;- image_border(test, &quot;red&quot;, &quot;10x10&quot;)
test &lt;- image_annotate(test, &quot;This is how we combine transformations&quot;, color = &quot;white&quot;, size = 30)
print(test)
</code></pre>

<pre><code class="language-r">##   format width height colorspace matte filesize density
## 1    PNG   465    240       sRGB  TRUE        0   72x72
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571403767170-586c2d88-c714-4d82-913b-4b61b8d6a946.png#align=left&amp;display=inline&amp;height=240&amp;name=image.png&amp;originHeight=240&amp;originWidth=465&amp;size=68492&amp;status=done&amp;width=465"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571403767170-586c2d88-c714-4d82-913b-4b61b8d6a946.png#align=left&amp;display=inline&amp;height=240&amp;name=image.png&amp;originHeight=240&amp;originWidth=465&amp;size=68492&amp;status=done&amp;width=465" alt=""></a></p>

<p>使用 <code>magrittr</code> 管道语法，可以使这一过程更具可读性。</p>

<pre><code class="language-r">image_read(&quot;https://jeroen.github.io/images/frink.png&quot;) %&gt;%
  image_rotate(270) %&gt;%
  image_background(&quot;blue&quot;, flatten = TRUE) %&gt;%
  image_border(&quot;red&quot;, &quot;10x10&quot;) %&gt;%
  image_annotate(&quot;The same thing with pipes&quot;, color = &quot;white&quot;, size = 30)
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571404067582-7fc5a16c-8f6a-400a-baa9-ce9a41800937.png#align=left&amp;display=inline&amp;height=240&amp;name=image.png&amp;originHeight=240&amp;originWidth=465&amp;size=68052&amp;status=done&amp;width=465"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571404067582-7fc5a16c-8f6a-400a-baa9-ce9a41800937.png#align=left&amp;display=inline&amp;height=240&amp;name=image.png&amp;originHeight=240&amp;originWidth=465&amp;size=68052&amp;status=done&amp;width=465" alt=""></a></p>

<h2 id="图像向量">图像向量</h2>

<p>上面的示例涉及的是单个图像。但是，Magick 中的所有函数都已经过向量化，以支持图层、合成或动画的处理。</p>

<p>标准的基本方法 <code>[</code> ，<code>[[</code>，<code>c()</code> 和 <code>length()</code> 可用于处理图像向量，然后可以将其视为图层或帧。</p>

<pre><code class="language-r"># Download earth gif and make it a bit smaller for vignette
earth &lt;- image_read(&quot;https://jeroen.github.io/images/earth.gif&quot;) %&gt;%
  image_scale(&quot;200x&quot;) %&gt;%
  image_quantize(128)

length(earth)
</code></pre>

<pre><code class="language-r">## [1] 44
</code></pre>

<pre><code class="language-r">earth
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/gif/126032/1571404482983-57993fcf-e477-444a-8508-b2c088e31f69.gif#align=left&amp;display=inline&amp;height=200&amp;name=image.gif&amp;originHeight=200&amp;originWidth=200&amp;size=237428&amp;status=done&amp;width=200"><img src="https://note.bioitee.com/yuque/0/2019/gif/126032/1571404482983-57993fcf-e477-444a-8508-b2c088e31f69.gif#align=left&amp;display=inline&amp;height=200&amp;name=image.gif&amp;originHeight=200&amp;originWidth=200&amp;size=237428&amp;status=done&amp;width=200" alt=""></a></p>

<pre><code class="language-r">head(image_info(earth))
</code></pre>

<pre><code class="language-r">##   format width height colorspace matte filesize density
## 1    GIF   200    200        RGB FALSE        0   72x72
## 2    GIF   200    200        RGB FALSE        0   72x72
## 3    GIF   200    200        RGB FALSE        0   72x72
## 4    GIF   200    200        RGB FALSE        0   72x72
## 5    GIF   200    200        RGB FALSE        0   72x72
## 6    GIF   200    200        RGB FALSE        0   72x72
</code></pre>

<pre><code class="language-r">rev(earth) %&gt;% 
  image_flip() %&gt;% 
  image_annotate(&quot;meanwhile in Australia&quot;, size = 20, color = &quot;white&quot;)
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/gif/126032/1571404528216-39cef120-0102-45f2-90d7-be2cf56a7099.gif#align=left&amp;display=inline&amp;height=200&amp;name=image.gif&amp;originHeight=200&amp;originWidth=200&amp;size=324322&amp;status=done&amp;width=200"><img src="https://note.bioitee.com/yuque/0/2019/gif/126032/1571404528216-39cef120-0102-45f2-90d7-be2cf56a7099.gif#align=left&amp;display=inline&amp;height=200&amp;name=image.gif&amp;originHeight=200&amp;originWidth=200&amp;size=324322&amp;status=done&amp;width=200" alt=""></a></p>

<h3 id="图层">图层</h3>

<p>我们可以像在 Photoshop 中那样，将图层堆叠在一起：</p>

<pre><code class="language-r">bigdata &lt;- image_read('https://jeroen.github.io/images/bigdata.jpg')
frink &lt;- image_read(&quot;https://jeroen.github.io/images/frink.png&quot;)
logo &lt;- image_read(&quot;https://jeroen.github.io/images/Rlogo.png&quot;)
img &lt;- c(bigdata, logo, frink)
img &lt;- image_scale(img, &quot;300x300&quot;)
image_info(img)
</code></pre>

<pre><code class="language-r">##   format width height colorspace matte filesize density
## 1   JPEG   300    225       sRGB FALSE        0   72x72
## 2    PNG   300    232       sRGB  TRUE        0   72x72
## 3    PNG   148    300       sRGB  TRUE        0   72x72
</code></pre>

<p>打印的图案相互镶嵌叠加在一起，从而扩展输出画布，使所有内容都适合：</p>

<pre><code class="language-r">image_mosaic(img)
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571404734099-24501fa4-75e2-4d48-95ea-6a5fde3b9bec.png#align=left&amp;display=inline&amp;height=300&amp;name=image.png&amp;originHeight=300&amp;originWidth=300&amp;size=87282&amp;status=done&amp;width=300"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571404734099-24501fa4-75e2-4d48-95ea-6a5fde3b9bec.png#align=left&amp;display=inline&amp;height=300&amp;name=image.png&amp;originHeight=300&amp;originWidth=300&amp;size=87282&amp;status=done&amp;width=300" alt=""></a></p>

<p>Flattening 扁平化处理将各个图层合并成一张与第一张图片大小相同的图片：</p>

<pre><code class="language-r">image_flatten(img)
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571405161840-eb8f469a-76b6-412a-ace6-bf2c869bd064.png#align=left&amp;display=inline&amp;height=225&amp;name=image.png&amp;originHeight=225&amp;originWidth=300&amp;size=80467&amp;status=done&amp;width=300"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571405161840-eb8f469a-76b6-412a-ace6-bf2c869bd064.png#align=left&amp;display=inline&amp;height=225&amp;name=image.png&amp;originHeight=225&amp;originWidth=300&amp;size=80467&amp;status=done&amp;width=300" alt=""></a></p>

<p>Flattening 和 mosaic 处理允许指定其他的复合运算符操作(<a href="https://www.imagemagick.org/Magick++/Enumerations.html#CompositeOperator">composite operators</a>)：</p>

<pre><code class="language-r">image_flatten(img, 'Add')
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571405411395-d162a0b9-6814-4ffd-a015-1e6f0c6bce66.png#align=left&amp;display=inline&amp;height=225&amp;name=image.png&amp;originHeight=225&amp;originWidth=300&amp;size=166194&amp;status=done&amp;width=300"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571405411395-d162a0b9-6814-4ffd-a015-1e6f0c6bce66.png#align=left&amp;display=inline&amp;height=225&amp;name=image.png&amp;originHeight=225&amp;originWidth=300&amp;size=166194&amp;status=done&amp;width=300" alt=""></a></p>

<pre><code class="language-r">image_flatten(img, 'Modulate')
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571405436852-2308d6e1-9ae8-48bb-86f3-831c5b363fd5.png#align=left&amp;display=inline&amp;height=225&amp;name=image.png&amp;originHeight=225&amp;originWidth=300&amp;size=40095&amp;status=done&amp;width=300"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571405436852-2308d6e1-9ae8-48bb-86f3-831c5b363fd5.png#align=left&amp;display=inline&amp;height=225&amp;name=image.png&amp;originHeight=225&amp;originWidth=300&amp;size=40095&amp;status=done&amp;width=300" alt=""></a></p>

<pre><code class="language-r">image_flatten(img, 'Minus')
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571405462410-4143125d-a04c-4721-9052-51d990f6ac30.png#align=left&amp;display=inline&amp;height=225&amp;name=image.png&amp;originHeight=225&amp;originWidth=300&amp;size=36730&amp;status=done&amp;width=300"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571405462410-4143125d-a04c-4721-9052-51d990f6ac30.png#align=left&amp;display=inline&amp;height=225&amp;name=image.png&amp;originHeight=225&amp;originWidth=300&amp;size=36730&amp;status=done&amp;width=300" alt=""></a></p>

<h3 id="合并">合并</h3>

<p>Appending 追加意味着将框架彼此相邻放置：</p>

<pre><code class="language-r">image_append(image_scale(img, &quot;x200&quot;))
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571405608571-3ffae337-e9a8-4106-ace7-96e783c5f2b1.png#align=left&amp;display=inline&amp;height=200&amp;name=image.png&amp;originHeight=200&amp;originWidth=625&amp;size=178774&amp;status=done&amp;width=625"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571405608571-3ffae337-e9a8-4106-ace7-96e783c5f2b1.png#align=left&amp;display=inline&amp;height=200&amp;name=image.png&amp;originHeight=200&amp;originWidth=625&amp;size=178774&amp;status=done&amp;width=625" alt=""></a></p>

<p>使用 <code>stack = TRUE</code> 可以将它们放置在彼此的顶部：</p>

<pre><code class="language-r">image_append(image_scale(img, &quot;100&quot;), stack = TRUE)
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571405677462-b6a743a6-6eae-4aa9-a57b-1cfeb469ffdf.png#align=left&amp;display=inline&amp;height=355&amp;name=image.png&amp;originHeight=355&amp;originWidth=100&amp;size=46278&amp;status=done&amp;width=100"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571405677462-b6a743a6-6eae-4aa9-a57b-1cfeb469ffdf.png#align=left&amp;display=inline&amp;height=355&amp;name=image.png&amp;originHeight=355&amp;originWidth=100&amp;size=46278&amp;status=done&amp;width=100" alt=""></a></p>

<p>合成允许在特定位置上组合两个图像：</p>

<pre><code class="language-r">bigdatafrink &lt;- image_scale(image_rotate(image_background(frink, &quot;none&quot;), 300), &quot;x200&quot;)
image_composite(image_scale(bigdata, &quot;x400&quot;), bigdatafrink, offset = &quot;+180+100&quot;)
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571405764948-75c0f0fd-8705-4398-97a4-ac569584903a.png#align=left&amp;display=inline&amp;height=400&amp;name=image.png&amp;originHeight=400&amp;originWidth=533&amp;size=431139&amp;status=done&amp;width=533"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571405764948-75c0f0fd-8705-4398-97a4-ac569584903a.png#align=left&amp;display=inline&amp;height=400&amp;name=image.png&amp;originHeight=400&amp;originWidth=533&amp;size=431139&amp;status=done&amp;width=533" alt=""></a></p>

<h3 id="页面">页面</h3>

<p>当读取 PDF 文档时，每个页面都成为向量的一个元素。注意，PDF 是在读取时呈现的，因此需要立即指定密度。</p>

<pre><code class="language-r">manual &lt;- image_read_pdf('https://cloud.r-project.org/web/packages/magick/magick.pdf', density = 72)
image_info(manual)
</code></pre>

<pre><code class="language-r">##    format width height colorspace matte filesize density
## 1     PNG   612    792       sRGB  TRUE        0   72x72
## 2     PNG   612    792       sRGB  TRUE        0   72x72
## 3     PNG   612    792       sRGB  TRUE        0   72x72
## 4     PNG   612    792       sRGB  TRUE        0   72x72
## 5     PNG   612    792       sRGB  TRUE        0   72x72
## 6     PNG   612    792       sRGB  TRUE        0   72x72
## 7     PNG   612    792       sRGB  TRUE        0   72x72
## 8     PNG   612    792       sRGB  TRUE        0   72x72
## 9     PNG   612    792       sRGB  TRUE        0   72x72
## 10    PNG   612    792       sRGB  TRUE        0   72x72
## 11    PNG   612    792       sRGB  TRUE        0   72x72
## 12    PNG   612    792       sRGB  TRUE        0   72x72
## 13    PNG   612    792       sRGB  TRUE        0   72x72
## 14    PNG   612    792       sRGB  TRUE        0   72x72
## 15    PNG   612    792       sRGB  TRUE        0   72x72
## 16    PNG   612    792       sRGB  TRUE        0   72x72
## 17    PNG   612    792       sRGB  TRUE        0   72x72
## 18    PNG   612    792       sRGB  TRUE        0   72x72
## 19    PNG   612    792       sRGB  TRUE        0   72x72
## 20    PNG   612    792       sRGB  TRUE        0   72x72
## 21    PNG   612    792       sRGB  TRUE        0   72x72
## 22    PNG   612    792       sRGB  TRUE        0   72x72
## 23    PNG   612    792       sRGB  TRUE        0   72x72
## 24    PNG   612    792       sRGB  TRUE        0   72x72
## 25    PNG   612    792       sRGB  TRUE        0   72x72
## 26    PNG   612    792       sRGB  TRUE        0   72x72
## 27    PNG   612    792       sRGB  TRUE        0   72x72
## 28    PNG   612    792       sRGB  TRUE        0   72x72
## 29    PNG   612    792       sRGB  TRUE        0   72x72
## 30    PNG   612    792       sRGB  TRUE        0   72x72
## 31    PNG   612    792       sRGB  TRUE        0   72x72
## 32    PNG   612    792       sRGB  TRUE        0   72x72
## 33    PNG   612    792       sRGB  TRUE        0   72x72
## 34    PNG   612    792       sRGB  TRUE        0   72x72
## 35    PNG   612    792       sRGB  TRUE        0   72x72
</code></pre>

<pre><code class="language-r">manual[1]
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571406026171-f59acaba-02a2-4a3d-ab75-42f645a8658c.png#align=left&amp;display=inline&amp;height=792&amp;name=image.png&amp;originHeight=792&amp;originWidth=612&amp;size=35697&amp;status=done&amp;width=612"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571406026171-f59acaba-02a2-4a3d-ab75-42f645a8658c.png#align=left&amp;display=inline&amp;height=792&amp;name=image.png&amp;originHeight=792&amp;originWidth=612&amp;size=35697&amp;status=done&amp;width=612" alt=""></a></p>

<h3 id="动画">动画</h3>

<p>除了将矢量元素视为图层之外，我们还可以将它们制作成动画帧！</p>

<pre><code class="language-r">image_animate(image_scale(img, &quot;200x200&quot;), fps = 1, dispose = &quot;previous&quot;)
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/gif/126032/1571406143098-f13a0d12-6fa9-4267-9a3b-0e177b2c3253.gif#align=left&amp;display=inline&amp;height=150&amp;name=image.gif&amp;originHeight=150&amp;originWidth=200&amp;size=47658&amp;status=done&amp;width=200"><img src="https://note.bioitee.com/yuque/0/2019/gif/126032/1571406143098-f13a0d12-6fa9-4267-9a3b-0e177b2c3253.gif#align=left&amp;display=inline&amp;height=150&amp;name=image.gif&amp;originHeight=150&amp;originWidth=200&amp;size=47658&amp;status=done&amp;width=200" alt=""></a></p>

<p>变形创建了 <code>n</code> 个图像序列，这些序列逐渐地将一个图像变形为另一个图像。这样，它就变成了动画。</p>

<pre><code class="language-r">newlogo &lt;- image_scale(image_read(&quot;https://jeroen.github.io/images/Rlogo.png&quot;), &quot;x150&quot;)
oldlogo &lt;- image_scale(image_read(&quot;https://developer.r-project.org/Logo/Rlogo-3.png&quot;), &quot;x150&quot;)
frames &lt;- image_morph(c(oldlogo, newlogo), frames = 10)
image_animate(frames)
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/gif/126032/1571406281279-46422262-8568-438d-a358-8c786292d385.gif#align=left&amp;display=inline&amp;height=150&amp;name=image.gif&amp;originHeight=150&amp;originWidth=197&amp;size=143027&amp;status=done&amp;width=197"><img src="https://note.bioitee.com/yuque/0/2019/gif/126032/1571406281279-46422262-8568-438d-a358-8c786292d385.gif#align=left&amp;display=inline&amp;height=150&amp;name=image.gif&amp;originHeight=150&amp;originWidth=197&amp;size=143027&amp;status=done&amp;width=197" alt=""></a></p>

<p>如果您读入现有的 GIF 或视频文件，则每一帧都会变成一个图层：</p>

<pre><code class="language-r"># Foreground image
banana &lt;- image_read(&quot;https://jeroen.github.io/images/banana.gif&quot;)
banana &lt;- image_scale(banana, &quot;150&quot;)
image_info(banana)
</code></pre>

<pre><code class="language-r">##   format width height colorspace matte filesize density
## 1    GIF   150    148       sRGB  TRUE        0   72x72
## 2    GIF   150    148       sRGB  TRUE        0   72x72
## 3    GIF   150    148       sRGB  TRUE        0   72x72
## 4    GIF   150    148       sRGB  TRUE        0   72x72
## 5    GIF   150    148       sRGB  TRUE        0   72x72
## 6    GIF   150    148       sRGB  TRUE        0   72x72
## 7    GIF   150    148       sRGB  TRUE        0   72x72
## 8    GIF   150    148       sRGB  TRUE        0   72x72
</code></pre>

<p>处理各个帧并将其放回动画中：</p>

<pre><code class="language-r"># Background image
background &lt;- image_background(image_scale(logo, &quot;200&quot;), &quot;white&quot;, flatten = TRUE)

# Combine and flatten frames
frames &lt;- image_composite(background, banana, offset = &quot;+70+30&quot;)

# Turn frames into animation
animation &lt;- image_animate(frames, fps = 10)
print(animation)
</code></pre>

<pre><code class="language-r">##   format width height colorspace matte filesize density
## 1    gif   200    155       sRGB  TRUE        0   72x72
## 2    gif   200    155       sRGB  TRUE        0   72x72
## 3    gif   200    155       sRGB  TRUE        0   72x72
## 4    gif   200    155       sRGB  TRUE        0   72x72
## 5    gif   200    155       sRGB  TRUE        0   72x72
## 6    gif   200    155       sRGB  TRUE        0   72x72
## 7    gif   200    155       sRGB  TRUE        0   72x72
## 8    gif   200    155       sRGB  TRUE        0   72x72
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/gif/126032/1571406402520-423a1535-5913-4e06-94a0-9e95488ce051.gif#align=left&amp;display=inline&amp;height=155&amp;name=image.gif&amp;originHeight=155&amp;originWidth=200&amp;size=89259&amp;status=done&amp;width=200"><img src="https://note.bioitee.com/yuque/0/2019/gif/126032/1571406402520-423a1535-5913-4e06-94a0-9e95488ce051.gif#align=left&amp;display=inline&amp;height=155&amp;name=image.gif&amp;originHeight=155&amp;originWidth=200&amp;size=89259&amp;status=done&amp;width=200" alt=""></a></p>

<p>动画可以另存为 GIF 格式的 MPEG 文件：</p>

<pre><code class="language-r">image_write(animation, &quot;Rlogo-banana.gif&quot;)
</code></pre>

<h2 id="绘图与图形">绘图与图形</h2>

<p>该软件包的一个相对较新的组件是一个本地的 R 图形设备，它生成 magick 图像对象。它可以像用于绘制绘图的常规设备一样使用它，也可以打开一个使用像素坐标绘制到现有图像的设备。</p>

<h3 id="图形设备">图形设备</h3>

<p><code>image_graph()</code> 函数可打开一个新的图形设备，类似于 <code>png()</code> 或 <code>x11()</code> 。它返回要写入绘图的图像对象。绘图设备中的每个“page”都将成为图像对象中的一帧。</p>

<pre><code class="language-r"># Produce image using graphics device
fig &lt;- image_graph(width = 400, height = 400, res = 96)
ggplot2::qplot(mpg, wt, data = mtcars, colour = cyl)
dev.off()
</code></pre>

<p>我们可以使用常规图像操作轻松地对图形进行后处理。</p>

<pre><code class="language-r"># Combine
out &lt;- image_composite(fig, frink, offset = &quot;+70+30&quot;)
print(out)
</code></pre>

<pre><code class="language-r">## # A tibble: 1 x 7
##   format width height colorspace matte filesize density
##   &lt;chr&gt;  &lt;int&gt;  &lt;int&gt; &lt;chr&gt;      &lt;lgl&gt;    &lt;int&gt; &lt;chr&gt;  
## 1 PNG      400    400 sRGB       TRUE         0 72x72
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571407000357-cb0feb53-944a-4c8b-a424-f43b90c2a3c9.png#align=left&amp;display=inline&amp;height=400&amp;name=image.png&amp;originHeight=400&amp;originWidth=400&amp;size=66043&amp;status=done&amp;width=400"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571407000357-cb0feb53-944a-4c8b-a424-f43b90c2a3c9.png#align=left&amp;display=inline&amp;height=400&amp;name=image.png&amp;originHeight=400&amp;originWidth=400&amp;size=66043&amp;status=done&amp;width=400" alt=""></a></p>

<h3 id="绘图设备">绘图设备</h3>

<p>使用图形设备的另一种方法是使用像素坐标在现有图像的上面绘制。</p>

<pre><code class="language-r"># Or paint over an existing image
img &lt;- image_draw(frink)
rect(20, 20, 200, 100, border = &quot;red&quot;, lty = &quot;dashed&quot;, lwd = 5)
abline(h = 300, col = 'blue', lwd = '10', lty = &quot;dotted&quot;)
text(30, 250, &quot;Hoiven-Glaven&quot;, family = &quot;monospace&quot;, cex = 4, srt = 90)
palette(rainbow(11, end = 0.9))
symbols(rep(200, 11), seq(0, 400, 40), circles = runif(11, 5, 35),
  bg = 1:11, inches = FALSE, add = TRUE)
dev.off()
</code></pre>

<pre><code class="language-r">print(img)
</code></pre>

<pre><code class="language-r">## # A tibble: 1 x 7
##   format width height colorspace matte filesize density
##   &lt;chr&gt;  &lt;int&gt;  &lt;int&gt; &lt;chr&gt;      &lt;lgl&gt;    &lt;int&gt; &lt;chr&gt;  
## 1 PNG      220    445 sRGB       TRUE         0 72x72
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571407139092-e128d9ce-ba0c-4f7f-ae2e-e6ad3fb61a7d.png#align=left&amp;display=inline&amp;height=445&amp;name=image.png&amp;originHeight=445&amp;originWidth=220&amp;size=80400&amp;status=done&amp;width=220"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571407139092-e128d9ce-ba0c-4f7f-ae2e-e6ad3fb61a7d.png#align=left&amp;display=inline&amp;height=445&amp;name=image.png&amp;originHeight=445&amp;originWidth=220&amp;size=80400&amp;status=done&amp;width=220" alt=""></a></p>

<p>默认情况下，<code>image_draw()</code> 将所有空白设置为 0，并使用图形坐标来匹配图像大小，像素(宽度x高度)为左上角 (0,0)。注意，这意味着 y 轴从上到下递增，这与典型的图形坐标相反。您可以通过向 <code>image_draw</code> 传递定制的 <code>xlim</code>、<code>ylim</code> 或 <code>mar</code> 值来覆盖所有这些。</p>

<h3 id="动画图形">动画图形</h3>

<p>图形设备支持多帧，这使它很容易创建动画图形。下面的代码展示了如何使用 magick 图形设备实现来自非常酷的 <a href="https://github.com/dgrtwo/gganimate">gganimate</a> 包的示例。</p>

<pre><code class="language-r">library(gapminder)
library(ggplot2)
img &lt;- image_graph(600, 340, res = 96)
datalist &lt;- split(gapminder, gapminder$year)
out &lt;- lapply(datalist, function(data){
  p &lt;- ggplot(data, aes(gdpPercap, lifeExp, size = pop, color = continent)) +
    scale_size(&quot;population&quot;, limits = range(gapminder$pop)) + geom_point() + ylim(20, 90) + 
    scale_x_log10(limits = range(gapminder$gdpPercap)) + ggtitle(data$year) + theme_classic()
  print(p)
})
dev.off()
animation &lt;- image_animate(img, fps = 2)
print(animation)
</code></pre>

<pre><code class="language-r">## # A tibble: 12 x 7
##    format width height colorspace matte filesize density
##    &lt;chr&gt;  &lt;int&gt;  &lt;int&gt; &lt;chr&gt;      &lt;lgl&gt;    &lt;int&gt; &lt;chr&gt;  
##  1 gif      600    340 sRGB       TRUE         0 72x72  
##  2 gif      600    340 sRGB       TRUE         0 72x72  
##  3 gif      600    340 sRGB       TRUE         0 72x72  
##  4 gif      600    340 sRGB       TRUE         0 72x72  
##  5 gif      600    340 sRGB       TRUE         0 72x72  
##  6 gif      600    340 sRGB       TRUE         0 72x72  
##  7 gif      600    340 sRGB       TRUE         0 72x72  
##  8 gif      600    340 sRGB       TRUE         0 72x72  
##  9 gif      600    340 sRGB       TRUE         0 72x72  
## 10 gif      600    340 sRGB       TRUE         0 72x72  
## 11 gif      600    340 sRGB       TRUE         0 72x72  
## 12 gif      600    340 sRGB       TRUE         0 72x72
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/gif/126032/1571407398362-7081e08c-758e-4bc4-a0f0-0f19577dfbe4.gif#align=left&amp;display=inline&amp;height=340&amp;name=image.gif&amp;originHeight=340&amp;originWidth=600&amp;size=143883&amp;status=done&amp;width=600"><img src="https://note.bioitee.com/yuque/0/2019/gif/126032/1571407398362-7081e08c-758e-4bc4-a0f0-0f19577dfbe4.gif#align=left&amp;display=inline&amp;height=340&amp;name=image.gif&amp;originHeight=340&amp;originWidth=600&amp;size=143883&amp;status=done&amp;width=600" alt=""></a></p>

<p>要将其写入文件，您只需执行以下操作：</p>

<pre><code class="language-r">image_write(animation, &quot;gapminder.gif&quot;)
</code></pre>

<h2 id="光栅图像">光栅图像</h2>

<p>Magick 图像也可以转换为光栅对象，来用于 R 的图形设备。因此，我们可以将它与其他图形工具相结合。然而，请注意，R 的图形设备非常慢，且它有一个非常不同的坐标系，它会降低图像的质量。</p>

<h3 id="基础格栅">基础格栅</h3>

<p>Base R 有一个 as.raster 格式，它可将图像转换为字符串向量。Paul Murrell 在  <a href="https://journal.r-project.org/archive/2011-1/RJournal_2011-1_Murrell.pdf">Raster Images in R Graphics</a> 一文中给出了一个很好的概述。</p>

<pre><code class="language-r">plot(as.raster(frink))
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571407922083-b20af564-e572-4625-aed6-7548f4d40f34.png#align=left&amp;display=inline&amp;height=960&amp;name=image.png&amp;originHeight=960&amp;originWidth=1344&amp;size=158352&amp;status=done&amp;width=1344"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571407922083-b20af564-e572-4625-aed6-7548f4d40f34.png#align=left&amp;display=inline&amp;height=960&amp;name=image.png&amp;originHeight=960&amp;originWidth=1344&amp;size=158352&amp;status=done&amp;width=1344" alt=""></a></p>

<pre><code class="language-r"># Print over another graphic
plot(cars)
rasterImage(frink, 21, 0, 25, 80)
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571407956028-b089c903-ed99-473c-9f5b-2e651392646a.png#align=left&amp;display=inline&amp;height=960&amp;name=image.png&amp;originHeight=960&amp;originWidth=1344&amp;size=140624&amp;status=done&amp;width=1344"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571407956028-b089c903-ed99-473c-9f5b-2e651392646a.png#align=left&amp;display=inline&amp;height=960&amp;name=image.png&amp;originHeight=960&amp;originWidth=1344&amp;size=140624&amp;status=done&amp;width=1344" alt=""></a></p>

<h3 id="grid-包">grid 包</h3>

<p><code>grid</code> 包使您更容易在图形设备上叠加栅格，而不必调整绘图的 x/y 坐标。</p>

<pre><code class="language-r">library(ggplot2)
library(grid)
qplot(speed, dist, data = cars, geom = c(&quot;point&quot;, &quot;smooth&quot;))
</code></pre>

<pre><code class="language-r">## `geom_smooth()` using method = 'loess' and formula 'y ~ x'
</code></pre>

<pre><code class="language-r">grid.raster(frink)
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571408144100-826b55ec-e9d4-4c39-836f-0da5fef706d7.png#align=left&amp;display=inline&amp;height=576&amp;name=image.png&amp;originHeight=576&amp;originWidth=960&amp;size=163843&amp;status=done&amp;width=960"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571408144100-826b55ec-e9d4-4c39-836f-0da5fef706d7.png#align=left&amp;display=inline&amp;height=576&amp;name=image.png&amp;originHeight=576&amp;originWidth=960&amp;size=163843&amp;status=done&amp;width=960" alt=""></a></p>

<h3 id="raster-包">raster 包</h3>

<p>raster 包具有自己的 bitmaps 类，这些类对于空间应用程序很有用。将图像转换为栅格的最简单方法是将其导出为 <code>tiff</code> 文件：</p>

<pre><code class="language-r">tiff_file &lt;- tempfile()
image_write(frink, path = tiff_file, format = 'tiff')
r &lt;- raster::brick(tiff_file)
raster::plotRGB(r)
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571408309237-4dc17391-efbe-4329-ab0e-8c5ea2decf2f.png#align=left&amp;display=inline&amp;height=384&amp;name=image.png&amp;originHeight=384&amp;originWidth=1344&amp;size=73075&amp;status=done&amp;width=1344"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571408309237-4dc17391-efbe-4329-ab0e-8c5ea2decf2f.png#align=left&amp;display=inline&amp;height=384&amp;name=image.png&amp;originHeight=384&amp;originWidth=1344&amp;size=73075&amp;status=done&amp;width=1344" alt=""></a></p>

<p>你还可以手动将位图数组(bitmap array )转换为栅格对象，但这似乎会删除一些元数据：</p>

<pre><code class="language-r">buf &lt;- as.integer(frink[[1]])
rr &lt;- raster::brick(buf)
raster::plotRGB(rr, asp = 1)
</code></pre>

<h2 id="ocr-文本提取">OCR 文本提取</h2>

<p><code>magick</code> 最新的功能是利用 OCR 技术从图片中提取文本。这需要 <code>tesseract</code> 包。</p>

<pre><code class="language-r">install.packages(&quot;tesseract&quot;)
</code></pre>

<pre><code class="language-r">img &lt;- image_read(&quot;http://jeroen.github.io/images/testocr.png&quot;)
print(img)
</code></pre>

<pre><code class="language-r">## # A tibble: 1 x 7
##   format width height colorspace matte filesize density
##   &lt;chr&gt;  &lt;int&gt;  &lt;int&gt; &lt;chr&gt;      &lt;lgl&gt;    &lt;int&gt; &lt;chr&gt;  
## 1 PNG      640    480 sRGB       TRUE     23359 72x72
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1571449892209-b8ce6f94-af33-4fc8-b59a-a0d0da8ae277.png#align=left&amp;display=inline&amp;height=480&amp;name=image.png&amp;originHeight=480&amp;originWidth=640&amp;size=5367&amp;status=done&amp;width=640"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1571449892209-b8ce6f94-af33-4fc8-b59a-a0d0da8ae277.png#align=left&amp;display=inline&amp;height=480&amp;name=image.png&amp;originHeight=480&amp;originWidth=640&amp;size=5367&amp;status=done&amp;width=640" alt=""></a></p>

<pre><code class="language-r"># Extract text
cat(image_ocr(img))
</code></pre>

<pre><code class="language-r">## This is a lot of 12 point text to test the
## ocr code and see if it works on all types
## of file format.
## 
## The quick brown dog jumped over the
## lazy fox. The quick brown dog jumped
## over the lazy fox. The quick brown dog
## jumped over the lazy fox. The quick
## brown dog jumped over the lazy fox.
</code></pre>

<h2 id="总结">总结</h2>

<p>本文章篇幅很长，对 magick 包的各种使用非常直观详细。作为与 “ImageMagick” 绑定，可用的最全面的开源图像处理库，magick 包支持许多常见格式（png，jpeg，tiff，pdf 等）和操作（旋转，缩放，修剪，修剪，翻转，模糊等）。这些所有操作都是通过 Magick ++ STL 矢量化的，这意味着它们可以在单个帧或一系列帧上进行操作，以处理图层，拼贴或动画。</p>

<p>在 RStudio 中，可以将图像打印到控制台后会自动预览，从而形成一个交互式编辑环境。因此，强烈推荐大家在 RStudio 中进行使用和测试。</p>

<p>更多 magick、ImageMagick 相关的 R 语言高级图像处理操作，有兴趣的童鞋可以自行去研究学习，也欢迎大家留言交流。
&gt; <strong>参考资料：</strong>
&gt;
&gt; <a href="https://cran.r-project.org/web/packages/magick/vignettes/intro.html">https://cran.r-project.org/web/packages/magick/vignettes/intro.html</a></p>


  <footer>
  
<nav class="post-nav">
  <span class="nav-prev">
      
      <a href="../../../topic/tech/2019-10-16-pcfnsd/">Cool New Features in Python 3.8</a>
      <br/>&larr;&nbsp;
      
  </span>
  <span class="nav-next">
      
      <a href="../../../topic/tech/2019-11-13-obs/">OBS 录屏的一些配置与使用</a>
      <br/>&nbsp;&rarr;
      
  </span>
</nav>
<script type="text/javascript">
document.addEventListener('keyup', function(e) {
  if (e.target.nodeName.toUpperCase() != 'BODY') return;
  var url = false;
  if (e.which == 37) {  
    
    url = '\/topic\/tech\/2019-10-16-pcfnsd\/';
    
  } else if (e.which == 39) {  
    
    url = '\/topic\/tech\/2019-11-13-obs\/';
    
  }
  if (url) window.location = url;
});
</script>



<section class="comments">
<script src="https://utteranc.es/client.js"
        repo="shenweiyan/issues"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</section>




<script async src="../../../js/fix-toc.js"></script>

<script async src="../../../js/center-img.js"></script>

<script async src="../../../js/right-quote.js"></script>

<script async src="../../../js/no-highlight.js"></script>

<script async src="../../../js/fix-footnote.js"></script>

<script async src="../../../js/math-code.js"></script>

<script async src="../../../js/external-link.js"></script>

<script async src="../../../js/alt-title.js"></script>

<script async src="../../../js/header-link.js"></script>

<script async src="../../../js/dom-scripts.js"></script>


<script async src="//cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>



  
  
  
  

  <script type="text/javascript" src="//rf.revolvermaps.com/0/0/6.js?i=5m6pzaeh5ar&amp;m=0&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=0&amp;bv=0" async="async"></script>
  </footer>
  </article>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
  </body>
</html>

